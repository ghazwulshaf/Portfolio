@model Project
@{
    Layout = "_LayoutDashboard";
    ViewData["Title"] = Model.Title ?? "Add Project";

    var tagsCount = Model.Tags.Any() ? Model.Tags.Count : 0;
}

<div class="px-12 py-4 *:mt-4">
    <div class="card first:mt-0">
        <a asp-action="Index" asp-controller="DashboardProjects" class="flex w-fit items-center"><i data-feather="arrow-left" class="inline h-4"></i> Back</a>
    </div>

    <div class="card">
        <form method="post" asp-action="@ViewData["FormAction"]" asp-controller="DashboardProjects" asp-route-guid="@Model.Guid" enctype="multipart/form-data" class="flex flex-col gap-4">
            <input type="hidden" asp-for="Id">
            <input type="hidden" asp-for="Guid">
            
            <div>
                <label asp-for="Title" class="label">Title:</label>
                <input type="text" asp-for="Title" class="input" placeholder="Project title..." autofocus>
                <span asp-validation-for="Title" class="text-sm text-red-500"></span>
            </div>

            <div>
                <label class="label">Thumbnail:</label>
                <input type="file" id="thumbnail-input" name="ThumbnailFile" accept="image/*" class="input">
                <img id="thumbnail-show" src="@Model.Thumbnail" alt="thumbnail" class="w-96 mt-2">
            </div>

            <div>
                <label asp-for="Description" class="label">Description:</label>
                <textarea asp-for="Description" class="input" rows="3" placeholder="Project description..."></textarea>
            </div>

            <div>
                <label asp-for="Type" class="label">Type:</label>
                <select asp-for="Type" class="input">
                    <option value="" disabled selected>-- Select Type --</option>
                    @foreach (var Item in ViewBag.ProjectTypes)
                    {
                    <option value="@Item.Name">@Item.Name</option>
                    }
                </select>
            </div>

            <div>
                <label class="label">Tags:</label>
                <input type="text" id="tags-input" class="input" placeholder="Type tag...">

                <div id="tags-items" class="flex gap-2 mt-2">
                @foreach (var Tag in Model.Tags)
                {
                    ViewBag.State = "Show";
                    ViewBag.ItemId = Tag.Id;
                    ViewBag.ItemName = Tag.Name;
                    <partial name="./_Tag.cshtml" for="@Model"></partial>
                }
                </div>
            </div>

            <div>
                <label asp-for="LiveView" class="label">Live Demo Url:</label>
                <input type="url" asp-for="LiveView" class="input" placeholder="Live demo url...">
            </div>

            <div>
                <label asp-for="CodeView" class="label">Code View Url:</label>
                <input type="url" asp-for="CodeView" class="input" placeholder="Code view url...">
            </div>

            <div>
                <label class="label">Content:</label>
                <textarea name="ProjectContent" id="summernote"></textarea>
            </div>

            <div class="flex justify-center gap-2 last:mt-8 mb-4">
                <button type="submit" class="button button-dark">@ViewData["Button"]</button>
                <a href="@Url.Action("Index", "DashboardProjects")" role="button" class="button button-light">Cancel</a>
            </div>
        </form>
    </div>
</div>

@section Scripts
{
    <script>
        feather.replace();
    </script>

    <script>
        $(document).ready(() => {
            $('#thumbnail-input').change((event) => {
                const file = event.target.files[0];
                const imageShow = document.querySelector('#thumbnail-show');

                if (file) {
                    const reader = new FileReader();

                    reader.onload = (e) => {
                        imageShow.src = e.target.result;
                    }

                    reader.readAsDataURL(file);
                }
            })

            var itemId = @tagsCount;

            $('#tags-input').keypress((e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();

                    var itemName = $('#tags-input').val();
                    var data = {
                        itemId: itemId++,
                        itemName: itemName
                    };

                    $.ajax({
                        url: '@Url.Action("AddTag", "DashboardProjects")',
                        type: 'GET',
                        data: data,
                        success: (response) => {
                            $('#tags-items').append(response);
                            $('#tags-input').val('');
                            feather.replace();
                        }
                    });
                }
            })
        })
    </script>

    <script>
        function DeleteTag(elementId) {
            const tag = document.querySelector('#' + elementId);
            const name = document.querySelector('#' + elementId + '-Name');

            tag.remove();
            name.value = null;
        }
    </script>

    @if (Model.ContentFile != null)
    {
    <script>
        $(document).ready(() => {
            const summernoteEditor = document.querySelector('[name="ProjectContent"] + .note-editor');
            fetch('@Model.ContentFile')
                .then(response => response.text())
                .then(data => {
                    summernoteEditor.querySelector('.note-editable').innerHTML = data;
                    summernoteEditor.querySelector('.note-placeholder, .note-control-selection').style.display = 'none';
                })
                .catch(error => console.error('Error content: ', error));
        })
    </script>
    }
}